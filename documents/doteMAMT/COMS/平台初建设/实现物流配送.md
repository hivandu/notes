# 实现物流配送

物流配送流程是完成订单从配送中到配送完成的过程，这里订单是指用户订单。



在实际的业务系统中，我们会将订单的商品信息转化成物流配送独有的订单（即运单）。运单会对用户订单进行合单或者分单的操作。完成配送其实是完成运单的过程，负责物流配送的系统叫作TMS。



TMS，即运输管理系统，它是Transportation Management System的英文缩写，其主要功能是对物流环节中运输环节的具体管理，包括车辆管理、在运途中的货物管理等。



## 运输的定义

运输从含义上来说主要是做人和物品的空间转移，对运输过程的监控和优化就是运输系统需要做的事情。运输的核心价值在于在做人和物品的空间转移过程中主要保证如下几点。



- 保值：能够确保在运输过程中货物价值不发生变化和损失，比如标品不会出现包装破损毁坏不可用的情况，生鲜冻品保持鲜活冷藏，热食保证抵达后温度在可食用范畴等，由于货品的属性不同，因此就会产生不同的运输工具和运输方法。
- 成本可控：这里面没有说成本低而是指可控，其原因在于为了保证保值这个条件，有一些成本是必须花销的；成本可控在于如何在保证基础成本的前提下优化现有成本结构，这是运输系统的主要核心工作之一；成本控制主要在于人员管理、设备管理（如车辆）、流程管理和调度安排管理等几个方面。



运输是做人和物的空间转移，转移的过程需要经历若干的节点，通过逐级传递的方式完成最终的运输配送。运输的节点从前到后依次是仓库、分拣中心、站点和客户，这里面的仓库和分拣中心都是WMS中的一部分，仓库属于备货区的存储功能，而分拣中心（DC）负责分拣发货的完成。客户除了个人用户外还包括大客户和商家。我们按照4个节点的流转画出一张运输配送的流转图，如图：

![image-20210227131950955](http://qiniu.hivan.me/picGo/20210227131950.png)



可以看到，线上场景中更多的是多对多的衔接关系，O2O则相对简单一些。在4个节点进行大规模的配送只靠人工是实现不了的，需要有更精细化的系统来实现，TMS就是负责配送、调度的。在这4个节点中，业务的角色包括仓库/DC、物流调度、配送司机3种，它们和仓库、采购一样，都是通过单据实现确认、交接等工作的。单据产生和流转的过程如图：

![image-20210227132007179](http://qiniu.hivan.me/picGo/20210227132007.png)





所有的配送都是根据订单情况制订运输计划来进行的。



物流运营部门拿到运输计划后会和相关承运商进行车辆的预约，对应生成相关的预约单。承运商根据运营的预约单进行车辆的实际指派，生成派车单，与此同时，仓库/分拣中心将要运输的货物进行分拣打包，同时生成出库单。被指派的司机根据派车任务来到仓库/分拣中心提货、装车，对货品进行运输，如果当前运输是支线运输，那么货品会被配送到下一个中转地收货，如果是直送，则直接运输到目的地完成签收。需要注意的是，这里的运输不包括最后一公里的配送，最后一公里配送是通过快递人员从站点直接配送。支线运输，运输类型按距离分为干线运输、支线运输、摆渡运输和最后一公里。



干线运输指长远距离的运输，一般为跨区域或者长距离跨城市的运输调拨，主要行驶的路段为高速公路或者城市主要干线公路，一般运输的周期比之其他类型会较长。



支线运输指中距离的运输，一般为城市与城市之间。



摆渡运输为城市内中转站间的调度运输。



“最后一公里”中的“一公里”是一个概念而不是具体的距离，一般特指最后一段配送的路程，范围一般在5千米以内。



流程中出现了几种单据：运输计划、预约单、派车单、派车任务和出库单。这里面出库单属于WMS的部分，其他几种都属于运输配送的单据。除此以外，对于出车以后的异常情况报备也需要进行单据任务管理。以下分析下几种单据具体都在管理什么事情。

## 计划与预约

运输计划和预约单是成对出现的。运输计划共有4个状态：

1. 已创建
2. 已确认
3. 已约车
4. 已作废



计划创建以后运输计划状态为已创建，人工确认后状态变为已确认，这时候的运输计划同步给物流管理部门，它们可以进行预约单的生成。预约单的状态为已创建、已确认、已派车和已作废。



例如，有一批货要从A仓库运送到B仓库，包含的商品很多。运输计划中会包含货物的总体积、重量、箱数和商品数量明细等。按照这个计划的情况，物流部门创建预约单，一个运输计划可以关联多个预约单，每个预约单主要记录根据运输计划预计派出的车辆情况，如车型、承运商和运输方式等。需要说明的是，运输方式决定结算费用，不同方式的计费不太一样，比如整车运输、贵品运输、退货运输、干线和支线等方式的运费是不同的。预约单能够确定负责的承运商和计划安排的车辆情况，但没有确定具体车辆信息。预约单确认后，运输计划会变为“已派车”状态，而运输计划作废则预约单同步作废，不过预约单为“已派车”的则不能作废。

## 派车

预约完成以后，承运商就会根据预约单情况安排派车。派车根据实际情况分为计划派车和临时派车两种。计划派车主要是根据预约单进行派车。派车时会同步生成派车单和派车任务，派车单记录车辆信息，派车任务记录流转情况和最后用户结算使用。只有已确认的预约单才可以安排派车，理论上派车单和预约单是多对多的关系，既可以一个预约单关联多个派车单，又可以一个派车单关联多个预约单。派车任务和派车单是一对多的对应关系。当派车单变成“已确认”状态时，对应的预约单也需要变为“已派车”状态。简单地说就是有多个需要预约的事情，指派一辆车按照派车任务的分配逐步完成每个预约单子。



## 资源管理

**运输都是由资源进行支撑的，这里重点讲一下两种资源的管理：车辆和运力。**



车辆管理比较好理解，每个车辆都需要进行跟踪、监控，车辆的车况和运输的核销是车辆管理的重点。



每辆车都是有损耗的，为了能够最大限度地使用车辆，以降低成本，我们需要对车辆的所有情况进行监控，包括以下内容:

- 车辆人员管理：指对车辆分配的驾驶员、班组和行驶证等信息进行管理。
- 车辆运营资源管理：这里是说对于车辆运营过程中需要使用的资源（包括ETC、加油卡等）进行管理。
- 车辆安全管理：车辆日常行驶过程中的安全情况记录，包括事故情况、理赔情况等。
- 车辆运行日志：包括日常出车记录及异常情况报备。
- 车辆维修管理：记录车辆维修记录和保养情况。
- 车务管理：对于车辆的日常事务进行管理，包括保险、年检、税费和违章等。



“运力”的概念可以理解为是承包运输线路的承运商。



每条线路需要在有足够运力的情况下才能按需完成运输计划，因此运力的管理和监控也是非常重要的。同一个运输线路上可以允许出现多个运力组织。打一个比方，车辆就如同火车站的火车，而运力就是车组（如北京到上海），不同的车组可以通过同一线路将旅客从一个站点运送到另一个站点，而车组可能属于多个运营铁路局，运力和线路是多对一的关系。通过对承运商的招标管理可以最大限度地优化成本，在成本计算时会基于多个资源的情况进行综合计算，包括对车辆类型、司机成本、装载量和行驶路程等多个维度的价格进行成本计算。所有的承运商要通过审核完成资源的进场使用，包括对承运商的资质、承运能力和规模等信息进行综合评估。

## TMS系统解构

运输业务的概念了解之后，接下来看看系统应该如何设计，以及按照业务流程和节点来进行划分的TMS系统应该是什么样的职能范围。



TMS主要负责运输，那么运输的准备工作就需要通过TMS来完成。TMS系统的上游系统主要是WMS，它们之间的界限一般是根据出仓来切分的。



此外TMS流转的单据是运单，运单是指在运输过程中用于进行管理跟进的单据。运单信息是根据订单信息拆分而成的（注意，运单信息一般与订单子单信息相同，但不是订单的子单），所以订单系统需要根据仓库、商品和商家等维度进行拆单和预分拣，而预分拣的处理逻辑则属于TMS系统的子系统预分拣系统。预分拣系统会将预分拣的结果提供给订单，由订单下传给WMS进行生产。出库的单据一般默认是按照预分拣的结果出库分配的，发运过程则由TMS的另一个子系统DC（Distribution Center，发运中心）完成。



考虑到配送过程不是所有的运单都是自营配送的，大多会转包给第三方的快递公司，如申通、顺丰等，这时就需要我们能够对快递公司进行监控、管理和结算。传统认知来看，发运系统一般等同于TMS，但实际上，TMS系统的范畴更广一些。



整体来看，**TMS系统的核心模块主要包括预分拣、发运管理和快递承运商结算等3块**，这3块的核心逻辑如下：



预分拣指的是将订单按照分拣规则进行拆单，这里的分拣不是指仓内的“分拣”概念。拆单后的子单在TMS生成运单时基本可以做到一一对应。预分拣的处理流程是在审单完成后，订单系统将待分拣的订单提交给预分拣系统，由预分拣系统根据规则进行判断，如果无法完成系统预分拣则转为人工分单，最终会将分单结果回告订单系统，由OMC订单中心统一下发给WMS进行生产。按照拆分后的订单生产完毕后，会在出库的时候根据子单出库，TMS根据出库单情况生成运单，进行配送，大致流程如图:

![image-20210227132109651](http://qiniu.hivan.me/picGo/20210227132109.png)



预分拣以后的订单会根据实际业务场景进行发货配送，配送的流程各家平台相对来说都是标准化的，这里面讲一下几种不同的发运模式，包括商家直配、在库统配和在库中转等。



商家直配指的是商家通过自身物流体系完成配送工作，商品不进入平台的仓库中进行存储分拣。在库统配指的是供应商将商品运抵平台仓库，在仓库中存放，通过平台的WMS和TMS进行统一配送。在库统配除了使用平台仓配的第三方商家外，自营发货也属于这个模式的一种。而在库中转则是每次发单由供应商将商品送至仓库，然后直接通过分拣完成发货的指令，也就是在WMS中讲到的越库模式。



发运过程则是根据上图所示的流转图，将仓库的货物通过各个节点完成发货配送的工作。特别说一下快递公司的分配。一般会按照快递公司的区域、仓库设置对应的关系映射，对多个快递公司进行优先级排序选择。



快递运送完成后，我们需要根据情况对快递进行结算，大致的结算关系如下:

- 快递正向配送后，平台将运费结算给第三方快递
- COD的正向配送，由顾客给第三方快递费用
- 销退时平台需要支付第三方快递费用
- 上门退货时，运费由平台方支付给第三方快递，该费用根据情况可以由平台承担，也可以由顾客承担。退货的商品费用需要原路返回用户账户



结算账目为以下内容:

- 快递结算：支“运费”
- 客户结算：收“运费”，支“代收款”
- 承运商结算：支“干线费”
- 网点结算：支“取件费”“派件费”，收“代收款”
- 小件员结算：支“提成（取、派）”，收“代收款”
- 干线结算：收“干线费”
- 客户结算：收“运费”
- 网点结算：支“分摊的运输费”



## TMS系统交互

TMS虽然是最下游的系统，但其交互系统并不少，除了WMS、订单以外，还会和支付系统进行传输对接，对于COD的用户则会进行POS支付。此外，商家还可以通过开放平台获取TMS的物流信息。TMS和3PL也会进行订单数据同步和状态获取。3PL（Third-Part Logistics）是指第三方物流公司。关系如图:

![image-20210227132134178](http://qiniu.hivan.me/picGo/20210227132134.png)