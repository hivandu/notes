# 实现购买流程

## 用户端

用户端作为直面用户的主要渠道，代表了平台的形象。



用户端的功能几乎是中、后台产品功能、价值的“缩影”。用户端交互设计和界面设计的内容在市面上已经很多，本文档内仅重点讲解用户端背后各个系统的业务关联和结构，具体实现交由后续产品去完成。



用户端一直有着迷之尴尬的地位，充当门面却深受各个系统的“牵连”（比如POS系统）。



所有系统的最终表现都依赖于用户端的展现，因此用户端是产品价值的最终体现。我们来看一下用户端内部都有什么功能：

![image-20210227130214551](http://qiniu.hivan.me/picGo/20210227130214.png)



用户端的主要功能是提供购买方式和商品展示，并能够协助用户进行个人服务管理。



从服务用户的阶段来划分，它主要分成售前、售中和售后3个阶段。其中个人信息的管理贯穿整个使用过程。

1. 售前环节：实现用户购买前的浏览和检索

2. 售中环节：实现用户的购买

3. 售后环节：提高信息透明度和服务体验

4. 个人中心：服务中转站

5. API

## 交易系统

交易系统作为购买流程的中枢系统之一，承担着所有订单的计算判断。很多相关业务系统都可以通过调用交易系统的服务来实现交易环节的功能。



这整个一节内所介绍的是交易系统的核心功能，也是交易系统对外提供的服务能力。



交易系统，顾名思义，是负责完成用户交易过程的系统。



交易的过程主要指通过各种交易的先决条件来判断应该如何确定最终交易的内容、事项和金额等信息，整合后提交订单系统完成订单生成的工作。通俗地说，就是用户在确定购买内容后，和平台签约并形成书面合同（也就是订单）的过程。



交易系统的主要功能是负责处理用户提交的信息，以及针对这些信息进行预处理计算，最后完成订单提交：

![image-20210227130340258](http://qiniu.hivan.me/picGo/20210227130340.png)



从流程上来看，交易系统负责的是生成订单以前的所有环节，而订单系统则负责订单生成后直到履约完成的所有环节。一些平台也会将订单系统包括在交易系统之内，订单管理作为大交易系统的一个子模块。这里把两个系统作为平行的关系进行拆分，拆分以后的系统职能边界更为清晰。用户下单的整个过程中，以订单提交为节点，前面部分属于交易系统，而后面的部分属于订单系统。



这里特别要单独说一下购物车，购物车原则上属于前台系统，但由于它的特殊性，它也会涉及大量的促销计算和运费计算的逻辑，购物车的后台可以通过调用交易系统的服务来实现上述计算。



就像买房买车一样，在签订合同之前销售人员会针对你的情况和购买的商品做很多预先的准备工作，比如资质的评估、费用的评估和优惠的力度等，这些信息都会通过核对沟通达成一致后录入合同。



在平台销售中也是一样，我们在确定下单之前，交易系统也会充当销售人员的角色，根据用户的填写信息进行核准判断、交易金额的明确和促销情况的明确等，确认通过后完成订单的下单提交。因此，在用户端负责对接交易系统、进行订单确认的页面一般也叫订单确认页或者结算页。



接下来我们来看看订单合同一般都需要对哪些事情进行处理和预先确认。



- 合同双方分别是平台和用户，用户的身份信息需要记录下来，这里面有用户的账户信息和收货人信息。
- 合同中需要交易的商品信息也是合同的主要内容之一，它包括商品的名称、编码（一般系统中以商品ID为准）、商品价格和商品购买数量等。
- 合同中需要记录乙方（平台）对甲方（用户）提供的服务条款和服务收费明细准则，按照术语说就是运费规则、促销规则和配货规则等。



根据上述对于订单合同的描述，我们可以将事项分为几个部分：信息的录入核准、费用的计算核准和履约形式的确认等。交易系统的主要功能包括以下几项。



### 用户信息记录

记录用户信息，如名称、收货人地址（姓名、联系方式和地址）、可收货时间、收货方式、支付方式和发票等。信息记录看起来是比较简单的功能，但这些信息与后面一些计算逻辑是密切相关的。举个例子，收货人地址目前在其他电商平台中通用的都是五级地址，即国家、省、市、县（区）、镇（街道）和详细地址。通过这五级地址可以计算出仓库配货的情况、是否有移仓等信息，而通过用户账号的信息可以判断是否享受鱼乐卡优惠或者其他运营活动等。



### 促销优惠计算

在计算商品金额之前，我们需要预先把促销优惠的金额计算出来。根据促销载体来看，促销优惠分为商品促销和集合促销两种情况。商品促销指的是将优惠的金额直接在商品的价格上做减免或打折，那么当前商品的销售价格应该为促销的价格或者折后的促销价格。而集合促销指的是多个商品进行捆绑优惠，比如满减、满折等。在计算这种促销的时候，需要根据促销的优惠规则将优惠的金额按照商品价格占比摊到每个商品上。假定本次购买有N件商品参与优惠，以下为分摊的逻辑。

- 前N-1件商品优惠分摊逻辑：平摊在商品上的订单优惠补贴=单品优惠价×［订单优惠总金额/（参与订单优惠的商品对应的单品优惠价之和）］。
- 剩余1件商品优惠分摊逻辑：最后一件商品分摊金额=订单优惠金额-平摊在（N-1）件商品上的优惠金额。



优惠券作为一种特殊的促销形式，也需要按照上述促销的思路进行计算。最终所有的优惠金额都会在商品和订单两个维度体现出来。（一直以来都想在POS上实现两个维度的优惠体现，商品和订单优惠完全是不相同的，订单优惠涉及到商品平均承担，而商品优惠则是单个受体，如果要实现订单内的部分退款，就必须先实现两个维度的优惠。）



促销、优惠券在计算时还需要考虑两者之间的关系，即，是互斥还是共享。



可以将促销分为限时抢促销和其他促销，抽象原则上，限时抢属于单品范畴的最低价格；而券种除了一般意义上的红包优惠券外，将线下单独售卖的储值卡单独分开判断，加上单品的VIP价格，我们共有5种优惠方式需要参与计算。



判断是否是共享还是互斥的大体思路是尽量避免在同一个细分维度（比如品类、单品）上做两次以上的促销减扣，同时核销方式不同的促销形式可以进行一定程度的叠加。



可以将互斥和共享的情况分列如下：

| **关系**                | **规则**                   |
| ----------------------- | -------------------------- |
| 互斥                    | 优惠券与储值卡             |
| 优惠券与促销            |                            |
| 优惠券与VIP             |                            |
| 限时抢与VIP             |                            |
| 共享                    | 储值卡与促销（除限时抢外） |
| 储值卡与VIP             |                            |
| 促销（除限时抢外）与VIP |                            |

**在O2O场景下，单品如果已经执行了特价，则订单不能再进行优惠券的使用，这也是为了避免同一方承担双重补贴的问题。**



### 商品金额计算

商品金额计算是指计算当前订单需要消费的金额情况，这部分的明细内容与订单系统是一样的。



订单的最终消费金额=商品售卖价格-促销优惠金额-优惠券优惠金额-储值卡优惠金额-其他抵扣+运费+保险费用。



其中运费的判断来自于是否满足运费减免条件，一般平台的减免条件都是满足金额门槛即可减免运费。其他抵扣指的是可能出现的虚拟货币的抵扣，比如积分抵扣等。



商品金额计算的时候要做最小容错检验，订单的最终金额不能出现负数。当订单金额小于等于0时，考虑核销的原因，订单金额一般记录为0.01，有可能为多个优惠减免导致，则下订单时由于已经减免到最小值，应当将所有优惠减免项按照优先级判断使用哪个。



### 运费计算

运费是指使用配送服务后需要用户承担的运输费用。大多数的电商平台或者店铺都会在满足一定订单金额后减免运费，但运费依然是订单金额的一个有效组成部分。



运费金额主要是根据配送区域和配送方式来计算的，因此运费的计算依赖于收货地址；同时运费的计算维度一般是按包裹单进行计算的（包裹单的概念详见“配送逻辑”），这几个维度都会决定运费金额的差异。



运费金额一般是通过运费模板来进行设置的，设置的时候就会从这些维度来进行细分，包括但不限于按照收货地、发送方式、商品件数、金额、是否分合包裹、发出仓和顾客身份等。此外，配送方式的多种多样决定了运费的不同，平台一般会配置多套运费模板来设定对应配送方式下的运费规则，用以计算使用；配送方式包括以下几种：

- 普通快递
- 平邮
- 特快专递（EMS）
- 自提
- 3小时递（8~17点之间下单且完成支付的订单）
- 慢递优惠
- 顺丰快递
- 转送（如京东配送等）
- ……



### 支付方式判断逻辑

在支付方式的选取上也需要进行一系列的检验和判断处理。



一般来说，网鱼能与第三方合作形成的支付方式包括第三方在线支付、银行闪付、余额、储值卡、优惠券、积分抵扣和COD（Cash on Delivery，货到付款）等。如果选择COD，需要根据收货地址判断是否支持，而储值卡或者优惠券在单个订单上只能使用一张。多种支付方式支付时则需要在生成订单时将订单商品金额拆分到对应的商品明细上以便对订单进行后续的操作。



### 配送逻辑

配送逻辑包括配货逻辑和预计送达时间计算，这两块逻辑是紧密关联的。



根据配货远近、商品在库库存是否充足、是否需要移仓调拨来满足订单等信息，最终预估出预计送达时间。因此送达时间计算的前提是配货逻辑。在配送逻辑之前，需要先理解一下配送是基于什么维度进行作业的。一般来说，我们通常将配送订单理解为按照订单维度进行作业，但实际上订单也有几层关系：交易单、订单和包裹单。



交易单对于网鱼来说，是一个未来业务，其实就是指顾客一次提交订单中的所有商品集合，下单形式一般是加入购物车后二次选择进行提交，单次提交的商品中可能包括不同商家或者店铺的商品，有一些平台级别的集合促销行为也是基于这个维度进行金额计算的。而这种交易单的行为必须是基于平台在线上进行实现的，举例来说，最大可能做实现的场景（目前网鱼还未有如此场景）：用户dubin在网鱼APP上进入自家附近（友谊路）的门店购买了一个周边商品，但是因为友谊路门店可能部分商品缺货（比如鼠标），所以dubin又在其他门店（也可能是总部商店）购买了鼠标，这个时候，这两家门店的商品需要进行合成一笔订单来进行支付，以便享受一个订单折扣的优惠券。



以上例子内可以看出，交易单不能作为配送的标准订单，系统应按照商家加配送方的维度将交易单拆分成若干的订单，订单的判断依赖于几个维度：收货人信息、配送方式、支付方式和发票等。这个维度的订单是属于用户的，但实际配送的时候还会根据实际情况进行合拆单。



合拆单是按照配货逻辑的不同来判断是否可以一次进行配送，即打包成一个包裹，因此这个维度的订单也叫包裹单，这个订单是真正意义上可以追踪的用户订单，在这个维度中用户可以进行售后、评价等行为的处理。理论上商家的配送方式和发货仓都是统一的，因此订单和包裹单一般情况下数量会是相等的，但如果出现同一笔订单有不同的发货方式或发货仓，就会出现一笔订单多个包裹单的情况。其实，配货逻辑应该是针对最终的包裹单来说的。



配货逻辑是根据顾客购买地、购买商品品种和库存计算包裹发出仓和发送方式的逻辑。不同的配货逻辑结果会影响到预计送达时间。配货逻辑的计算基准是收货人信息的五级地址中的第四级，也就是我们通常说的行政区。如果平台在同一个城市有多个仓，则会按区域划分不同的配送方，但如果同一个城市只有一个仓，则可以按照三级城市来进行判断。一个仓库可以对应多个区域或者城市进行配送设置。我们按照收货地址的远近将仓库分为本地仓（或者本区域仓）和外地仓。如果本地仓无法完成全单配送，则需要通过移仓逻辑完成调动，或者判断是否通过外地仓进行配送。仓配模式有以下几种情况。

- 区域字母仓配货
- 网状仓配货
- 中央仓直发



子母仓模式指在全国范围内指定部分母仓来覆盖几个区域，每个区域有子仓。配货时优先查看子仓是否全单满足，如果不满足则从母仓调拨。如果母仓全单满足，则不做调拨而直接从母仓发货。子母仓的结构要确保母仓的商品品类丰富、充足，母仓既可以当作子仓的供应方又可以作为子仓的补充来快速发货，从而减少移仓时间和成本。子母仓的结构在时下比较流行的新零售领域被称为大仓和前置仓，逻辑上是类似的。



网状仓指每个母仓都覆盖多个区域，可以为不同区域的子仓进行调拨，满足子仓的订单出库。网状母仓之间覆盖会有一定的区域重合，配送时选择哪个母仓调拨要优先考虑物流成本和时效。



中央仓直发，指建立一个全品类的中央仓，中央仓建立在物流较为便利的城市中。通过中央仓直发商品来解决兜底无法配送的问题。在配置仓库时，无论是母仓还是子仓，原则上还是遵从就近原则，尽可能减少运输成本和移仓次数。



确定配货逻辑后，就可以根据配送情况估算配送时效即预计送达时间了。预计送达时间的处理是根据顾客的收货地址、下单时间、发送方式、送货时间、发货仓库、支付方式和截单时间等计算预计送达时间。按照上述发货的方式，订单时间预估分为直发订单时间预估和移仓转发订单时间预估。

- 直发订单：预计送达时间=生产时间+最长送货时间。
- 移仓订单：预计送达时间=移仓时间+直发订单发送时间。





## 订单系统

设计订单系统时，几个大的方向需要考虑，这些内容决定了订单系统的稳定性和可持续性。



### 订单字段

订单字段包含了订单中需要记录的信息，它的作用主要用于沟通其他系统，为下游系统提供信息依据，结构如图：

![image-20210227130633199](http://qiniu.hivan.me/picGo/20210227130633.png)



订单信息包括订单号和订单状态机。



订单号作为订单识别的标识，往往由一串数字组成，根据订单的增加进行自增，也可以在设计订单号的时候考虑订单加密设置（否则别人通过订单编号就能计算出对应的销售量）。



订单号用作订单的唯一标识，用于对接WMS和TMS的订单识别。



用户信息在这里指购买人的相关信息，主要包括姓名、地址和手机号等。网鱼的模式更偏向于O2O，因此还会多一种情况，就是自提点（即门店），这样地址会变为自提点的地址。地址信息在后续会作用在WMS和TMS上，用于区分区域和配送安排。



购买商品信息指购买商品的基本信息和库存，由于金额比较特殊，因此将金额独立在商品信息以外讲，不过逻辑上它们其实都属于商品信息范畴。商品信息主要影响库存更新和WMS生产。



金额信息记录订单产生的商品金额。除了要记录最终的金额，过程金额也需要记录，比如商品分摊的优惠金额、支付金额和应付金额等，它们在后续的订单结算、退换货和财务等环节都需要使用。



时间信息是记录订单每个节点的触发时间。



这里特别说一下“订单标识位”的概念。订单标识位，有的地方叫服务标记，有的地方叫SendPay，其实从逻辑上来说都是一样的意义。标识位是一串若干位数的字符串，通过对不同位的定义来表示不同的含义。比如我们在订单中设置一个字段，这个字段具备100位数字，每一位数字可以为0到9的数字，它们代表不同含义，这样我们就可以通过这100位字符串代表订单的不同含义和标记，比如第14位数字代表预售，如果是0则代表正常订单，如果是1代表预售订单。标识位主要用于对订单的特殊逻辑进行标记处理，以便下游系统在接收订单后可以根据标记进行业务处理，比如分拣、仓配类型或是否大小件贵品等。



### 订单流程

订单流程是指整个订单从产生到完成的整个流转过程，它包括正向流程和逆向流程。



正向流程是从订单正常生成到配送的过程，如图:

![image-20210227130708502](http://qiniu.hivan.me/picGo/20210227130708.png)



以上所示模块是一般电商通用的功能，部分可以根据实际业务场景进行增加调整。O2O场景下的出库、合包裹和发票准备等工作由商家进行，部分工作属于线下场景。



整个流程涉及的环节非常多，需要注意几个地方：



- 订单生成环节存在超时未支付导致订单自动取消的过程，库存的占用会在订单取消后释放。
- 如果选择COD，则支付环节相应转移到订单配送之后，而过程中所有与款项相关的逻辑变为只操作金额数字，不对结算和账户进行打退款操作。
- 金额分摊需要到商品。
- 订单系统审核主要对恶意用户或者刷单情况进行处理。系统可根据白名单、黑名单、消费频次和促销品购买量等方面做风控规则。如果后续会进入到人工审核，则规则上可以适当放宽。当触发规则时需要进行订单退订的行为。此处设计时要小心对用户体验的损害，前台文案上需说明当前节点是审核状态或者是等待接单。
- 在O2O领域有催单的概念，传统电商则是通过关联第三方物流的物流信息进行跟踪。考虑到实际场景，催单触发一般会设定一定的时间间隔，间隔时间内只触发一次催单的请求。
- 预售等货和移仓需要做成SOA服务，以便在交易页面计算预计送达时间。移仓处理依赖仓库的情况，也会涉及后续拆分和合并包裹的逻辑。
- 订单生产时先要判断报缺情况，如果出现报缺问题，则要考虑整单报缺、部分报缺、换货或者换转退的情况（库存、仓促调拨和退款）。报缺情况分为系统报缺和实物报缺，这是有承接关系但相对独立的两个环节。
- 线上商城（电商）系统要考虑7天无理由退货的场景，即订单状态完成后申请退货，此时主要涉及的是金额上的计算以及一些财务程序（如发票等）问题的处理，更多的需要考虑门店分成问题。



逆向流程则指订单取消、退货等情况引发的订单流程过程，如图：

![image-20210227130718772](http://qiniu.hivan.me/picGo/20210227130718.png)



在设计逆向流程时，与正向流程分开，通过订单号等信息进行关联，避免耦合过多导致逻辑无法延展设计。



逆向流程的触发主要有以下几种情况：



- 用户自主取消订单（整单）
- 风控系统触发取消订单（整单）
- 客服接到客诉仲裁后触发取消订单（整单）
- 超时未支付取消订单（整单）
- 换货报缺转为退单（整单、部分报缺）



触发条件应考虑两个方面：



- 订单状态机［某一节点后（如交班、跨天）不允许取消订单］
- 订单生成时间（主要是O2O方面，考虑到配送时间和线下流程的不规范，有可能出现状态机没触发更新但实际流程在流转的情况）



其他要注意的事项：



- 当退单被门店拒绝后，需要转入客服仲裁的环节。
- 部分退货的订单促销一般保持享用状态，但按照分摊的金额进行退款。



从业务流程上来看，订单流程是按照上述节点进行流转的，但从系统结构来看，订单系统的流程其实拆分成若干的步骤完成。从生成到最终完成，所有相关订单处理后，选定对应的仓库推送给WMS进行生产、配送，主要的处理逻辑如图:

![image-20210227130730367](http://qiniu.hivan.me/picGo/20210227130730.png)



上图中列举的是一些主要的订单功能，而不是所有的功能，每个订单系统都会有一些自己独有的系统拆分，不过逻辑上来说是一样的。



首先是生成订单，从交易系统获取基本的数据进行订单生产，订单包括母单和子单。生成的订单信息会提交给订单中心，风控模块首先会判断订单信息是否属于恶意订单，如果属于恶意订单，则申请系统取消订单并回告用户；如果属于非恶意订单，则根据所属仓库、支付方式和订单类型等判断拆单和需要下传的下游信息。同时管道服务会将对应的订单信息同步给相关的非业务系统，比如台账记账、发票等。在拆单和预分拣的时候，有时会出现用户订单生成后却暂时没有匹配到对应的仓库进行下发的情况，那么在订单的状态节点中可以增加一个订单转移的概念，未转移的订单认为还是仅仅完成生成，而转移后的订单会下发仓库进行生产。



订单还有两个模块是属于全局性质的，即Promise和订单跟踪（或者也叫状态回告）。Promise主要负责计算预计送达时间，它会根据仓配情况和供应商情况进行整体计算；而订单跟踪可以理解为对应订单状态机在发生变化时需要通知相关业务系统，订单回告可以通过MQ（Message Queue，消息队列）的方式由业务系统订阅，一旦有变更，则由订单系统主动推送业务系统信息以保证及时性。图内只画了回告交易，其实其他业务系统也可以接受回告信息。



### 订单状态机

“关于状态机的一个极度确切的描述是它是一个有向图形，由一组节点和一组相应的转移函数组成。状态机通过响应一系列事件而‘运行’。每个事件都在属于‘当前’节点的转移函数的控制范围内，其中函数的范围是节点的一个子集。函数返回‘下一个’（也许是同一个）节点。这些节点中至少有一个必须是终态。当到达终态，状态机停止。”

— 来源：百度百科《[状态机-状态机综述](https://baike.baidu.com/item/状态机)》



由百度摘抄可以看到，状态机是用来表示按照一定的方向通过触发不同节点产生数据流转的过程。在订单中通过情景触发订单状态的变化来表达订单流转的过程，就是订单状态机。



**线上订单的订单流转**

![image-20210227130804250](http://qiniu.hivan.me/picGo/20210227130804.png)



**O2O的订单流转**

![image-20210227130818249](http://qiniu.hivan.me/picGo/20210227130818.png)





线上销售和O2O的主体流程是相同的，不同的在于物流配送环节，线上较O2O更为复杂。此处只表明了主要的订单状态机，仓储物流内的物流单流转不在此范围内。**状态机原则上使用结果值而不使用过程值，比如使用“支付成功”作为节点而不使用“支付中”作为节点。**



订单状态机要融合订单流程来设计触发节点，订单流程的逻辑点要多于状态机，一般在当前流程环节完成后更新状态机。



### 订单推送

当状态机发生变化时，需要将对应的变化情况告知给相关人员，以便相关人员了解当前订单的情况，这就是订单推送的作用。订单推送和回告的区别在于，回告是周知系统，而推送是通过触达手段将信息推送给具体的人。



订单推送的触发依赖于状态机的变化，涉及的信息包括：

- 推送对象（用户、物流人员和商家）

- 推送方式（push、短信）

- 推送节点（状态机）

  

## 支付系统

支付系统作为完成营收的最后一个环节，是实现最终收入进账的过程，它既要保证钱款的流通安全，还要保证可以让用户有更好的支付体验，不至于等待时间过长。



在讲支付系统之前，我们先聊一下关于支付、总的流程和运转模式。我们现在讨论的支付系统指的支付功能，但实际完成支付并不只是支付系统，其背后还有一套完整的链条在运转。



一般在支付时都是通过对应的银行卡进行支付，包括储蓄卡和信用卡。在用户完成支付后，钱款最多会经历4个机构，即支付网关、收单行、卡组织和发卡行，4个机构会从中扣去一定的费用作为手续费。传统意义上说的第三方支付机构大多是属于网关的概念，它并不能直接对接发卡行。



### 支付模式

支付系统的核心工作就是管钱，负责用户侧资金进出的处理、监控。目前主流的支付模式包括以下几种。

- 第三方对接（主要是支付宝、微信和ApplePay等，其他的视情况而定）：这类公司具有成熟的对接手册和接口规范。如果想要了解细节，可以去对应的平台进行查看。

- 余额支付：一般通过网鱼会员卡的用户账户钱款进行支付，支付时直接从公司账目中进行划款。

- 银行卡：可通过绑定银行卡进行支付。

- 预支类：如白条、花呗，效果上同余额+信用卡的功能。

- 积分、红包：用于抵扣金额，一般不做现金兑换，这部是属于促销相关的内容。

  

### 支付流程

支付是通过支付机构（一般是第三方支付机构）将用户支付的款项转入公司账户的过程。支付的场景包括普通支付和免密支付。



在线支付系统主要是和第三方的支付机构进行交互，完成支付过程。退款也是如此。



**支付的基本流程**

![image-20210227130920700](http://qiniu.hivan.me/picGo/20210227130920.png)



支付过程要考虑以下几个事情。



- 请求支付时的补偿机制，避免支付账目核对不上
- 支付后的回执，确保支付结果可查，以便后续流程根据支付结果进行处理
- 支付完成后需要更新状态，状态包括支付状态和订单状态。需要关注状态机变化



在线支付除了常规的支付流程外，目前比较流行的还有小额免密支付。免密支付对用户来说既节省了时间，又减少了输入密码的麻烦。不过需要注意的是，支付系统在实现免密支付的时候需要考虑免密的风险问题，限定一定的额度，对于异常的支付请求需要做预警。关于异常支付监控的部分，关注风控系统。



免密支付的流程较之一般支付流程来说，增加了签约处理的过程，具体的流程如图：

![image-20210227130933497](http://qiniu.hivan.me/picGo/20210227130948.png)



### 退款流程

退款就是未完成交易的订单需要将用户款项退回用户账户，这个过程就是退款的过程。



退款流程的发起往往伴随订单的取消或者退货场景，它主要包括订单主动取消、订单被动取消、用户退单、用户部分退单、订单报缺和订单换转退等几种情况。





退款有两种基本流程，一般意义的退款流程和订单重复支付主动退款流程如图：

<img src="http://qiniu.hivan.me/picGo/20210227131011.png" alt="image-20210227131011135" style="zoom:50%;" />



重复支付的退款流程相对要复杂一些。重复支付是指用户为同一个订单支付了多次，需要针对历史记录和订单信息进行比对，根据金额比对结果进行相应的处理。在退款时要根据比对情况判断退款的款项是本次支付还是历史支付款项。



需要注意的是，退款时考虑到与第三方交互可能出现异常，当重试次数到达一定阈值时可以考虑发送邮件预警并转为人工处理退款，具体流程如图：

![image-20210227131525885](http://qiniu.hivan.me/picGo/20210227131525.png)





### 状态机

支付系统也有支付系统的状态机。从某种意义上我们也可以把支付的状态机看作订单状态机的二级状态机。



- 正向订单流程：支付状态机在订单待支付和订单支付成功之间。
- 逆向订单流程：发起退单后的退款申请阶段，直到退款完成后订单取消或者退款结束。



**支付状态机节点**

| **状态名称** | **状态解释**                                                 | **备注**     |
| ------------ | ------------------------------------------------------------ | ------------ |
| 未支付       | 支付网关接到支付请求，落交易单号病更新状态为“未支付”         | 终态或中间态 |
| 支付成功     | 用户支付成功                                                 | 终态         |
| 支付关闭     | 与支付宝小额免密约定，小额免密因额度不足导致扣款失败时的交易单状态 | 终态或中间态 |
| 转入退款     | 支付成功的订单进入退款流程，定有一笔退款单                   | 终态         |





**退款状态机节点**

| **状态名称** | **状态解释**                         | **备注** |
| ------------ | ------------------------------------ | -------- |
| 等待退款     | 系统生成的退款流水的初始状态         | 初始状态 |
| 退款中       | 第三方回调或者查询结果为“退款中”     | 中间态   |
| 退款成功     | 该笔款项已经远路退回给用户           | 终态     |
| 退款失败     | 由于某些原因，此次款项没有退回给用户 | 终态     |

## 系统逻辑

购买流程主要是用户和订单之间的关系。



用户可以下多个订单，每个订单上记录着多个商品。用户按照订单去支付订单款项，会在第三方支付机构对应生成一笔支付流水记录。理论上每个订单都对应着一笔支付流水，当然特殊情况也会出现多笔，比如重复支付。不过这不会是最终状态，最终状态订单和支付流水是一一对应的，如图：

![image-20210227131612038](http://qiniu.hivan.me/picGo/20210227131612.png)