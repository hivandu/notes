# 平衡自营和加盟间的关系

## 实现第三方开店售卖

### POP平台

电商平台化的概念在2010年左右开始被提及，很多电商企业都不满足于自营模式而开始进行平台化的布局。虽然时至今日除了少量的大型公司，如阿里巴巴、京东等存活外，其他不少平台转为了垂直电商，但不可否认的是，平台化确实为企业提供了更多的销售来源和性价比更高的管理方式。这里讲述一下第三方商家平台的产品架构和设计思路。

第三方商家平台包括提供商品售卖的商家和提供工具服务虚拟品的商家，与前者相关的平台叫作POP平台，后者叫作开放平台。我在这里提到的第三方商家平台特指POP平台。POP平台也叫招商平台或者商家平台。POP的全称为Platform Open Plan，它最早来自于京东的叫法，其实原则上天猫和淘宝也属于这种平台，但它们没有一个所谓的简称，因此我们在文中都简称为POP平台。

作为第三方商家的平台，POP平台内的所有流程和数据既需要满足独立的管理方式和运作规则，又要确保和自营平台的数据、逻辑不会产生冲突。对于用户来说，所有平台上的商品都是一样的，只有价格、品类和发货的区别而已。因此，搭建第三方商家平台的核心是保证两个大的部分的完成——**系统融合和商家流程搭建。**

### 系统融合

系统融合是指将商家的数据融于现有的数据体系内，并在用户操作的相关流程中实现统一。系统融合主要是购买流程链路相关的系统融合。自营和商家的后台管理部分是相对独立的流程，但与用户相关的中台和前台部分则需要统一。在主体流程上主要包括几个部分的改造：

- 商品系统打通
- 交易系统打通
- 订单打通



**商品信息融合**

POP平台的商品来自于商家，通过商家的后台进行管理，这里的管理包括商品录入、商品审核和商品上下架等。前面讲自营系统的时候说过，商品数据的下游系统很多，大多数的系统都需要使用商品数据，因此，为了保证商家的商品在这个业务链条中也可以正常使用，我们需要将商家的数据融合到当前的商品数据中去。通常我们会将商家商品的基础信息同步给商品系统，这里包括商品图片、名称、类目、价格和库存等。同样，商品来源不同也会标识不同的商品编码以做区别，比如，同样是雪碧，商家卖的和自营卖的就是两个不同的商品编码；而不同商家之间同一个商品也拥有不同的商品编码，在逻辑层面它们就是不同的商品SKU。所有这些商品在同步到商品系统时都需要打上商家商品的标记以进行区别。

使用时各个业务系统可以根据标识来进行不同的业务逻辑判断，比如搜索可以根据标识标记是否为商家SKU，排序优先级该如何，等等。涉及的主要业务系统包括以下几种。

- 搜索：展示商家商品搜索结果
- 推荐：站内实现商家商品推荐
- 订单：获取商家商品SKU的基本信息
- 价格：获取商家商品SKU价格信息
- 库存：获取商家商品SKU库存信息
- CMS：获取商品图片、名称等信息，生成前端展示页面



**交易信息同步**

商品信息融合后，下一步需要将相关的交易信息进行同步，以便交易系统在购买时获取信息。交易系统涉及的信息十分繁多，这里主要是对履约相关信息进行同步，比如预计送达时间、支付方式、运费和发货仓库等信息。交易信息的处理逻辑和自营是一样的，不同的是发货履约的仓库模式有所不同，会形成不一样的交易信息。关于仓库模式将在后面详细讲解。



**订单融合**

最后就是订单的融合，其实严格意义上来说订单还是相对独立的。前面讲过，订单可以按照“商家+仓库”模式来进行拆分，拆分后的订单会同步到WMS进行生产，订单系统根据商品的商家ID信息进行区分。前面已讲到，商家与自营在履约环节最大的不同就是发货模式的不同，根据仓配的不同组合，可以罗列出若干种商家的仓库模式。

- 平台的仓库+平台的配送：使用平台的仓库进行存储、分拣，商家通过租用平台仓库面积的方式进行存货，订单进入仓库同自营流程一样进行分拣、打包，打包好的包裹通过平台统一的配送体系完成配送，这种模式叫作FBP（Fulfillment by POP）
- 商家仓库+平台的配送：第三方商家将订单商品进行分拣、打包后送至分拣中心（DC），然后由平台统一完成发货，这种模式叫作LBP（Logistics by POP），发票由平台开具，如果是由第三方商家开具，则属于SOPL（Sale on POP & Logistics by POP）
- 商家的仓库+商家自配送：在平台售卖以后，不使用平台的仓配体系，通过第三方商家自身的仓库、配送系统或快递完成所有订单的履约过程，通过第三方商家开具发票给消费者，这种模式也可以叫作SOP（Sale on Platform）

不同的仓库模式决定配货方是商家还是平台，开具发票由哪方来进行，由此，根据仓库情况、运力情况确定的预计送到时间也可以计算出来了。这里说一下识别这几种模式的方法，主要是判断结算主体是谁，一般由结算主体进行发票开具。有时候为了结算的便利，可以由平台作为实体将货权转移给平台后再进行仓库作业，这样实物其实并没发生变化，但用户发票的开具方就变为了平台。

按照上述描述，商家的相关系统和平台本身业务系统之间的交互如图：

![image-20210228220446030](http://qiniu.hivan.me/picGo/20210228220446.png)



这里没有画一些外延的系统，比如搜索、推荐等，这些系统会从平台中的这些基础系统中获取数据。



**促销系统融合**

也许看完上图大家会有些疑问，商家平台的商品可以参加促销吗？没错，促销系统的处理并没有体现在图中，那它的位置应该如何呢？促销系统并不能复用第三方商家自营平台本身的促销，其原因是两侧的结算方式和结算主体不一样，费用、补贴的承担方也不一样。这样就需要在商家系统中实现促销的功能，这里的促销包括促销活动和优惠券。

促销的融合同其他系统类似，也需要将数据同步给平台的相关系统，POP平台的促销系统则提供给商家促销的设置工具。由于POP平台的商家有店铺的概念，每个商家都有自己独有的店铺，由此商家系统中所有的设置都是针对店铺维度进行的。有时候有些平台也会将整个平台做成一个大的POP平台，而自营商品则可以看作是一个特殊的店铺，商品是由平台本身采购发货而已。

商家促销的玩法也同自营一样，包括单品级促销和集合级促销，除此之外还包括店铺级的促销。前面提到了订单的拆单是按商家维度进行的，因此店铺级促销也可以理解为是订单维度，即这个商家的商品单独拆单，看是否满足促销要求。店铺级促销也可以看作是一个特殊的集合促销，它的玩法也包括满减、满折和满赠等形式。O2O的促销大多同电商平台的店铺级促销规则一样，因为O2O不允许跨店铺下单。

优惠券的玩法也类似，不过商家优惠券的使用范围主要是店铺级，即店铺内全品类可使用或者店铺内部分商品可使用。当然一些大的平台也会设置全平台的优惠券，全平台的优惠券大多是满减类的优惠券，补贴费用可以由平台和商家同时承担，理论上平台方承担费用x和商家承担费用y之和不能大于减免金额z。对于x、y的值，上线区间则可以通过后台进行规则设定，以避免出现超额的问题。

所有促销（包括促销、优惠券）整合后的交互如图：

![image-20210228220500297](http://qiniu.hivan.me/picGo/20210228220500.png)



### 商家业务

POP平台除了与自营类似的相关业务系统外，也有一些POP商家平台独有的系统，这些系统的业务流程主要是商家相关的业务流程。这里面比较核心的有以下几个流程。

- 商家入驻：商家入驻到平台的流程，包括商家信息填写和资格审核的流程
- 店铺装修：完成店铺的装修和设置
- 商家管理：管理店铺内部所有信息和商家的相关信息
- 商家结款：按周期进行结算



**商家入驻**

商家入驻是商家通过POP平台录入商家的基本信息和资质情况并提交申请开店的过程。商家入驻的流程总结下来主要包括3部分：信息录入、合规审核和资质审核。商家在录入信息时需要录入所有经营相关的信息，除了基础的商家名称、法人和银行信息外，还需要录入Logo、经营范围、法人身份信息、营业执照、注册号、注册地址和许可证等，这些信息可以证明商家的经营范围、经营能力和经营信息等，而这些信息也会在后续的审核中进行查实复验。

完成录入提交后，系统就进入了审核阶段。审核主要是进行合规确认和资质确认。合规确认是说确认当前提交信息是否满足法律法规的要求，要杜绝出现不符合规定规则的内容信息；而资质审核则是判断该商家是否具备所描述经营范围的能力和资格。下面列举一些主要的审核条件，见表审核类型及规则，实际业务中的审核需要根据业务具体诉求进行补充完善。审核的过程可以通过规则的配置实现部分自动审核，以提高效率。



**表审核类型及规则**

| **审核类型** | **审核项** | **审核规则**                                                 |
| ------------ | ---------- | ------------------------------------------------------------ |
| 合规         | 商家名称   | 是否与营业执照一致                                           |
| 合规         | 店铺名称   | - 是否有特殊符号 - 名称中禁止出现“总店” “分店” “连锁” “品牌” “加盟” “国家” “认证” “授权” “最**” “第一/Nol” “TOP 1”等类似词 （广告法） - 店名中不可出现禁售品名词，如“烟、狗肉”等，以营业执照 名称命名的，营业执照名称包含禁售品名词的也不行 |
| 合规         | LOGO       | - 不可以出现其他竞对平台信息 - 不可以出现二维码信息 - Logo信息需与商家经营品类相 |
| 资质         | 个人资质   | - 身份证信息是否真实有效 - 身份证是否在有效期内              |
| 资质         | 营业执照   | - 营业执照名称、注册号、有效期和地址等填写正确（完全按证 件照填写）； - 营业执照在国家相关网站上登记为吊销状态的不可用； - 上传营业执照图片需要清晰、无水印 |
| 资质         | 许可证     | - 生鲜、果品类的需要具备许可证； - 许可证在国家相关网站上登记为吊销状态的不可用 |



商家在开店过程中需要进行两部分信息的操作，第一部分就是入驻时的审核资料信息，在审核无异常的情况下，商家平台的运营人员会通过入驻提交申请，然后将对应的合同信息录入到平台的商家管理中，合同中会记录合同截止时间和所属经营范围、扣点等信息，这时候商家就可以进行开店的操作了。特别说明一下对于商家账号的划分，虽然从实体上来说大多数商家都是单店的模式，即每个商家只有一家店铺进行运营，但在考虑系统架构的时候需要支持商家多店铺运营，商家和店铺之间从逻辑上来说是两个主体，商家和店铺的对应关系是一对多的关系。因此在入驻审核时商家信息应作为入驻的基本信息进行审核，而填写的店铺相关的信息，比如店铺经营范围等也需要在审核时候一并提交，审核完毕后商家可以登录平台进行开店的操作。它们之间是商家与合同对应，店铺和商家对应，商品则是店铺内的商品。另外，权限上看，连锁店形式的商家可以根据总部和分店的概念设置后台权限，因此有一些总部级别的管理内容会放入商家管理中进行统一管理，而店铺维度的则会放入店铺管理模块进行。



**店铺装修**

接下来就是开店，它和线下开店的流程类似，需要对店铺进行装修，商品准备上架，一切完成后就可以进行对外销售了。线上装修是指对店铺的页面进行排版设置、组件设置。店铺装修的作用是能够通过装修的合理布局来提高访客的转化率。店铺装修原则上同CMS的原理是一样的，因此可以复用CMS的框架来实现店铺装修，不同的是店铺装修的组件相对特殊。按照类型，组件分为基础组件、商品组件和高级组件。

- 基础组件：店内海报、店铺招牌、分类管理、品牌故事、好评展示和品类排行等
- 商品组件：热卖橱窗、视频包装等
- 高级组件：品类定制、活动页定制和商户特色门面等



店铺装修的组件和布局通常也可以通过平台引入的ISV（Independent Software Vendor，独立软件开发商）来获取更丰富的组件类型，具体的开放平台部分将在下一节介绍。在店铺装修后台，组件可以根据情况自行选择。所有店铺内的页面都可以进行设计美化，不过一些特殊页面只能使用特殊的组件，比如商品详情页。除了基本的操作以外，后台还需要支持一些辅助功能，比如可预览效果、对整体布局进行大范围的调整优化等，辅助功能主要用来提高装修系统的易用性和使用效率。辅助功能见表**辅助功能**。



**辅助功能**

| **分类** | **功能**   |          |          |              |              |              |              |
| -------- | ---------- | -------- | -------- | ------------ | ------------ | ------------ | ------------ |
| 装修页面 | 多版本     | 店铺页   | 列表页   | 商品详情页   | 店铺简介页   | 公共头部     | 自定义页数量 |
| 操作     | 保存       | 发布     | 预览     | 浏览         | 恢复         | 恢复         | 恢复         |
| 辅助功能 | 可视化编辑 | 布局装修 | 背景设置 | 页面基础设置 | 页面基础设置 | 页面基础设置 | 页面基础设置 |



店铺装修一般包括PC端和App端两部分，随着移动互联网的发展，App端的使用人数已渐渐超过PC端的人数。相对于PC端来说，App的界面更小，因此对组件的使用大多聚焦在一些常用组件上，对一些复杂的结构多使用浮层跳转的方式来解决。App端常用的组件类型包括以下几种。

- 轮播图：俗称Banner，一般为5~10帧，宽度通常为屏幕的1/5以内，多用于热点活动或者主推商品的广告
- 热门分类：分类导航，也叫类目导航，通常会将常用类目或者主推类目放在首页醒目的位置，通常在轮播图的下方
- 双列图：和1×4广告图一样，用来放置促销或者热门流量商品
- 1×4广告图：同双列图作用一样
- 商品推荐：商品推荐往往是以列表形式存在的，它将主要的商品集合以列表形式呈现在首页；以往还有瀑布流的形式，不过瀑布流样式看着比较乱，目前主流的样式是一行两列的列表形式
- 礼券领取（包括列表）：礼券领取有两种方式，一种是列表页，另一种是领取组件放置在首页；往往会把礼券放在商品列表前，原则上尽量避免跳出当前页面，减少用户流失
- 活动页：主题形式的活动页面，同CMS的活动页



**商家管理**

店铺装修是门面管理，而店铺内的管理就是商家店铺管理功能模块负责了。商家店铺管理可以理解为商家系统的统称，广义上它包括店铺装修、商家结算以及所有与商家运营相关的部分，狭义上来说它主要负责日常运营过程中的系统功能。商家系统的功能模块如图：

![image-20210228220555353](http://qiniu.hivan.me/picGo/20210228220555.png)



商家运营部分包括3个部分：运营管理、运营辅助和商家管理。其中，运营管理和运营辅助主要面向第三方商家，而商家管理则面向平台的运营人员。运营管理同之前的相关内容一样，包含中台系统几乎所有的功能模块。商家管理主要负责对平台商家进行监控、审核，需要注意的是，商家商品上架时需要运营人员对其进行审核处理，未通过的商品不允许进行售卖。运营辅助主要是商家相关的数据和服务指导，它包括4个大的部分。

- DSR体系：商家评分体系，是顾客动态评分，它衡量一个店铺的整体服务水平
- 服务市场：即后面要讲的开放平台，主要为商家提供第三方的支持工具，商家可以通过购买的方式选择自己使用的工具或者服务
- 商家大学：类似于平台的帮助中心，不同的是商家大学的内容更为丰富，除了包括商家自发的UGC内容外，运营也可以通过制作一些视频或者文章来指导商家进行开店经营或解答商家问题；商家大学可以用BBS的形式来呈现，也可以以课堂的形式呈现，具体呈现形式可以参考业务实际情况
- 数据罗盘：服务商家进行数据监控、分析，等同于BI系统和CRM系统的作用

这里面重点说一下DSR体系和商家考核体系。DSR最早来自淘宝，全称是“Detail Seller Rating”，即卖家服务评级系统，它主要包括商品（是否和描述相符，评价如何）、物流（是否及时，商品配送是否无损）和服务（态度如何，响应如何）等。这3个选项都是买家在购买完成后进行评价的部分，通过加权计算后得到商家的每项平均分和总分。DSR直接反映商家的整体水平，它的评分会影响商家在相关系统的排名，比如搜索排名。

商家考核体系主要是对各项数据指标进行评估，制订标准，进行优胜劣汰，确保平台商家可以处于良性的竞争环境中而逐步发展。除了上述的DSR评分考核以外，还可以对销售、服务和物流相关的数据进行考核。考核优异的商家，比如品类销售冠军、广告贡献冠军、单品销售冠军、0差评商家、0客诉商家和48小时发货率100%等，可以通过奖励资源位的方式进行鼓励，而评估较差的商家则需要进行警告，长期没有提升的商家则可能进行降权或者末尾淘汰的处理。

最后我们说一下商家结款的部分。商家结款主要涉及和财务系统的交互、结算和打款等行为，财务系统是标准化的系统，业内很多开发商做得不错，因此在电商系统中没有介绍财务系统。结算一般有两个主要步骤——计费和结算单流程。通常由平台的结算体系进行费用计算，然后根据结算的数据生成结算单。这块主要是一些财务流程。重点说明一下商家结款的流程以及商家结款中相应单据的状态机变化。

商家在结款过程中主要通过生成结款单来完成结款操作，如图：

![image-20210228220607124](http://qiniu.hivan.me/picGo/20210228220607.png)



结款单会按照账期进行处理，结款单的数据来源于订单，我们可以设定一个周期，比如5天，订单完成5天后进入可结算状态，通过日结作业将结款数据进行计算保存。每个账期到期日期前一天（比如账期15天，第14天时）对日结作业处理的数据进行汇总，计算出账期的数据。将计算的最终账期结算数据（即结算单）同步给商家和财务，由双方进行核对确认，确认无误后，财务进行打款并完成账期的勾兑。更新勾兑完成的订单与账期结算单的状态并通知商家，商家获取支付完成的信息后可以核对银行账户金额。需要注意的是，结算时的计算公式应该是：$本期结算金额=本期商家应收账款-本期商家应付账款-往期拖欠账款$。$当本期应收>本期应付+往期拖欠金额$时，则正常出账，拖欠金额为0，$账单结算金额=本期应收-往期拖欠金额-本期应付$；当$本期应收<本期应付+往期拖欠金额$时，则账单结算金额为0，$往期拖欠金额=本期应付+往期拖欠金额-本期应收$。拖欠款与应付金额的抵扣逻辑为：先抵扣欠款金额，后抵扣应付。本期应付一般包括商家本期消费金额，如购买第三方应用服务，还有逆向订单的费用和金额。逆向订单包括发货报缺、自助退货和拒收等。逆向订单的金额需要和正向订单金额分开统计计算。



订单完成后会进入结转流程，而结转流程的订单也有独立的状态机，这些状态机不同于用户订单的状态机，它们需要单独存储处理，如图：

![image-20210228220615721](http://qiniu.hivan.me/picGo/20210228220615.png)



我们将完成状态的订单（包括失效、取消等状态的订单）分为有效订单和无效订单，无效订单不需要参与结算，有效订单在结算日将通过日结作业完成计算存储。每个账期截止日应将账期内结款日的计算金额汇总统计，生成结算单，结算单完成勾兑后，订单状态变为“结款完成”，而该账期的结算单状态变为“已结账”。



## 接入更多的第三方服务，完善商家环境

第三方商家以店铺的形式入驻平台，并出售自己的产品（实物商品或虚拟商品）。同样，平台也会引进另一种类型的商家入驻，它们通常不直接面对C端消费用户，而是面对入驻的第三方商家提供销售、库存和经营管理等支撑工具。这种形式类似于现在的App Store或者Google Store，所售卖的商品大多也是以服务的形式接入平台。我们将它们入驻的平台视为POP平台的一个独立组成部分，一般称其为开放平台（Open Platform，OP）。



### 开放平台商家和POP商家的差异

开放平台也属于商家入驻的范畴，因此对商户的信息审核依然是有必要的。商户审核完毕后完成入驻行为，POP商家则需要进行开店上架，完成售卖前的准备工作。而在开放平台完成售卖的准备工作需要开放平台商家完成应用或者服务的开发、测试和调试的工作，开放平台商家也叫ISV，后面如果没有特别说明，统一称之为ISV。

开放平台除了运营人员以外，还需要技术开发人员，这是与单纯销售的第三方商家不同的地方。开发完成后的服务或者应用需要上架销售，当用户购买后，ISV会请求平台完成授权的工作，授权后商家可以进行服务或应用的使用。平台的销售模式也与POP商家的有所不同，POP平台和自营一样，都是售卖商品（包括虚拟商品），以订单的形式完成金额的支付，订单完成后追加商品数量或者次数都需要另外购买。而开放平台的销售方式更像收费会员的机制，它按照一定周期购买使用，逾期则进行续费的行为。

ISV和POP商家原则上是两个不同的群体，但一些有开发能力的大型POP商户也会为自身开发一些定制化的应用，以便在平台上入驻运营，这时候ISV则可能是POP的技术团队。



### 开放平台的基础架构

开放平台的本质是将平台内的基础能力通过接口的形式开放给开放平台的服务商，服务商可以在此基础上完成二次开发，来实现一些更新维度的商家诉求。平台的基础能力主要是指与整个销售过程紧密相关的系统功能，比如商品、订单、优惠券、促销、配送等信息。当然开放平台也有其他特别的服务应用，每个平台都会根据自己情况进行进一步细分，比如淘宝就包括线下零售服务和线上虚拟机票等接入服务。

按照应用使用的场景，开放平台大致分为几个部分：数据分析、营销推广、店铺维护和上下游服务等。

- 数据分析：包括所有的经营数据和营销收据，类似于自营平台的BI
- 营销推广：提供POP商家营销推广的工具，包括CRM、会员、优惠券发放和活动管理等
- 店铺维护：主要负责对店铺页面进行管理，是平台中店铺装修的补充和扩展，OP可以提供更丰富的模板、样式，提供图片处理、排版功能，提供设计方面的支持，同时也提供店铺内的一些运营服务，比如客服等
- 上下游服务：对于售卖的上下游服务提供支持，比如提供代运营服务



按照这个结构，我们可以整理出大致的开放平台框架，如图：

![image-20210228220716422](http://qiniu.hivan.me/picGo/20210228220716.png)



开放平台将内部系统的数据或者服务通过封装的方式对外提供服务，开放平台提供接口以备ISV调用、开发、调试和对接等。开发完成上架的服务或者应用可以被用户在开放平台中搜索、查看和购买。



从数据流转来看，内部系统实现基础服务，提供基础数据，开放平台封装数据和服务，对外提供业务接口，ISV使用开放平台提供的接口完成应用的实现并通过沙箱测试。完成后的应用进行上架销售，POP商家可以浏览使用这些数据来进行业务运营。

从商家实操流程来看，则是商家入驻完成后获取授权，根据平台帮助文档和技术文档进行应用的开发，开发完成后在平台的沙箱测试调校，最终成品通过开放平台上架、销售。用户在购买时支付费用，所有费用信息会反馈在开放平台的后台，并进行财务对账和划款。

开放平台内部也有很多功能，不过开放平台是一个对接内部系统和第三方商家的平台，解决第三方对接的问题才是开放平台存在的核心意义。首先，所有的内部数据都需要通过这个平台对外提供和输出，因此平台的开发者中心是平台的核心功能；此外，由于内部数据对外的暴露，因此需要保证使用方的能力和合规性，我们会对商家进行资质审核，同时搭建OpenAPI来提供对外数据服务；最后就是关于平台的支付续费操作，由于支付模式的特殊性，平台续费变成一个相对高频的行为，我们需要制订续费的规则和逻辑。这里重点讲解一下这3个部分的搭建和构成，其他的常用功能（比如上/下架、购买流程等），这里就不作额外阐述了。



### 商家入驻及资质审核

商家入驻的基本流程同POP的基本流程类似，也需要填写信息和审核。审核内容同样包括商家（ISV企业）的基本法人信息、营业执照和经营许可证等信息。运营负责人的基本信息（包括姓名、联系方式、职位和身份证信息等）也需要提交，信息、资质审核完毕后，会通过平台推送或者线下联系等方式周知该运营负责人。

作为一个提供服务的开发商企业，ISV同样也需要明确经营范围并上传营业执照。在审核时需要核查该ISV所提报的应用类目是否在经营范围内，如果超出经营范围则审核不通过。所有企业上传的资质信息都需要在国家相关网站申报并处于有效状态。

认证未通过的ISV账户可以登录开发者中心，但不能上线应用。只有通过资质审核和运营信息审核以后，该ISV账户才能被允许进行后续的相关操作。因此，认证未通过的账户可以进行开发，获取沙箱环境的相关授权，但无法进行线上的授权获取。



### ISV开发者中心

开发者中心是开放平台不同于普通商家平台的核心功能，我们可以理解它为平台和第三方软件开发商合作完成一个项目，双方进行系统级别的对接交互平台。为了能够快速、高效地和多个ISV开发商对接，我们抽象了一条标准的生成流程和结构，以此为基础搭建的平台就是开发者中心。和所有软件工程的生产流程一样，我们都需要经过几个步骤：需求定义、需求方案确认、系统设计、系统开发、系统调试及系统上线，见表生产流程。



**生产流程**

| **流程节点** | **内部开发方式**          | **开发者中心方式**                                           |
| ------------ | ------------------------- | ------------------------------------------------------------ |
| 需求定义     | 确定需求范围              | ISV自行定义应用内容，并根据经营范围创建应用                  |
| 需求方案确认 | 确定需求具体方案，整理PRD | 下载开放平台的接口定义，申请App Secret和App Key， 包括证实环境和沙箱环境；设计业务对接流程 |
| 系统设计     | 设计技术方案              | 根据业务流程设计技术对接接口以及应用内部技术方案             |
| 系统开发     | 开发项目                  | 开发应用                                                     |
| 系统调试     | 测试项目                  | 根据接口定义在沙箱uanjing调试应用与平台的对接，包括数据获取、异常获取等 |
| 系统上线     | 上线项目                  | 操作应用上架                                                 |





开发者中心的原理和内部系统调用原理相似，平台和应用之间的交互形式主要有两种：API接口及消息推送，结构如图：

![image-20210228220750471](http://qiniu.hivan.me/picGo/20210228220750.png)



实时信息都是通过API接口进行通信的，开发者中心API对外统一称为OpenAPI，它的职责包括处理数据交互、校验参数信息、验证身份信息和建立防刷机制等。OpenAPI属于平台被动调用的交互方式，即应用请求获取数据信息，OpenAPI不会对业务逻辑进行计算处理，只会在原有业务系统提供的服务接口上封装一层，实现上述的功能。还有一种方式是由平台主动推送一些异步通信信息，如订单状态更新、履约变更信息等。这种无法明确交互时间的信息则由平台方通过应用提交的接口完成推送。我们可以理解为所有实时同步信息的获取主要通过OpenAPI进行，由应用方主动请求，交互形式是一对一；所有异步信息的获取则通过平台的消息推送，由平台方发起，交互形式是订阅方式的一对多。这两种交互形式会按照应用创建时填写的信息进行交互，其中推送地址用来进行消息推送，OpenAPI直接调用OpenAPI地址即可。

平台上的所有应用都具备简单的状态机，状态机代表应用当前状态及节点。每个节点都有对应的可执行操作，见表每个节点的可执行操作



**每个节点的可执行操作**

| **操作行为**   | **状态**   | **备注**                                           |
| -------------- | ---------- | -------------------------------------------------- |
| 创建应用成功   | 开发中     | 开发中的应用可以进行基本的增、删、改、查           |
| 应用提交审核   | 审核中     | 审核中应用不允许修改，需要等待下个节点才可以操作   |
| 用用审核通过   | 已上线     | 上线后的应用可以进行操作，不过操作后需重新提交审核 |
| 应用审核不通过 | 审核不通过 | 未通过的应用或者版本不会更新到线上                 |
| 应用已被下线   | 已下线     | 可人工进行下线操作                                 |



应用同样也有类型区分，通常意义上的应用都属于平台售卖应用（可能不同平台叫法不一样），除此之外，一些大型商家为自身定制开发的应用不希望对外展示售卖，这种应用属于企业级应用，对企业级应用的App Key和App Secret需要有所区分，这样可以保证开放平台前台在获取应用列表时过滤此类应用。



### 商家支付续费

商家在平台上购买ISV应用时需要支付相应的费用。平台应用通常有两种支付模式：试用和正常购买。试用通常用于新应用上线推广试用，每个商家的同一个应用只可以试用一次。正常购买就比较好理解，商家按照应用的规格（每个应用都可能出现多个规格，如简版、VIP版等，不同版本价格有所不同）进行支付，支付成功后，应用会出现在个人的应用列表中。每个应用都是有有效期的，商家选择的期限不同，费用也有所不同，当应用到期时需要商家进行续费。

续费的原则是同规格进行续费，即原来我购买的是VIP版本，那么续费依然是为VIP版本续费，不同版本属于新的购买，不可以跨版本续费。此外，当前ISV的应用规格处于不可售卖状态（应用下架或者当前规格下架）时也不允许续费。

续费是为保证商家的利益，避免因为购买时效过长导致ISV发生变化，从而影响商家利益，通常对商家续费的时长要进行控制限制。平台设定一个年限值（可以是1年，淘宝平台是2年），商家购买的时长与商家在此应用规格下当前可用时长之和需要小于年限值。大于年限值时则不允许购买，需要商家重新选择。举个例子，当前应用A的商家的可用时长为3天，商家续费时长为720天，则如果按照年限值为1年判定，时长超过年限值不允许进行续费。当然我们也可以在应用创建时不允许ISV设定过长的年限规格，不过这样可能会比较死板，体验不好。

除此之外，部分应用可能属于按次体验的服务，这类应用也不可以进行续费，只能按次购买。

