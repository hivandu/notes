---
date: 2020-01-11
author: Hivan
---



# 自助点单POS及服务实现



|文档版本|日期|作者|备注|
|---|---|---|---|
|v0.1|2021-01-11|杜斌|根据鱼助手点单需求分析服务实现。|
|v0.2|2021-01-12|杜斌|确定支持业务最小需要实现功能|
|v0.3|--|杜斌|完善设计稿|



## 概述

自助点单为用户自行点单，点单渠道有两部分，鱼助手和APP/小程序；

这两个渠道用户进行自助点单，有一些区别，本需求目前**仅针对鱼助手点单撰写**。[【鱼点单界面及业务流程】](https://www.notion.so/V1-0-544629e052e2457f90fdf05d3f6ae6a1)



## 干系人

| 序号 | 姓名   | 分工/职责  | 部门       | 联系方式             |
| ---- | ------ | ---------- | ---------- | -------------------- |
| 1    | XXX | 需求方     | 用户增值部 | xxx@wywk.cn  |
| 2    | 杜斌   | 产品经理   | 技术部     | xx@wywk.cn        |
| 3    | XXX | JAVA工程师 | 技术部     | xxx@wywk.cn  |
| 4    | XXX | 测试工程师 | 技术部     | xxx@wywk.cn   |
| 5    | XXX | 前端工程师 | 技术部     | xxx@wywk.cn    |
| 6    | XX   | JAVA工程师 | 技术部     | xxx@wywk.cn     |
| 7    | XXX | 产品经理   | 技术部     | xxx@wywk.cn  |
| 8    | XXX | JAVA工程师 | 技术部     | cxxxg@wywk.cn   |
| 9    | XX   | 技术负责人 | 技术部     | fxxxg@wywk.cn      |
| 10   | XXX | JAVA工程师 | 技术部     | zhxxxlei@wywk.cn |



## 需求



### 目标

支持在鱼助手上展示商品，支持用户在鱼助手上进行点餐操作，支持用户在鱼助手上直接付款；



### 点单流程整理

如图：蓝色为起点、绿色为正常流程节点、黄色为待确认、红色为难点（坑点）。

![自助点单整理](http://qiniu.hivan.me/picGo/20210111164312.png)



### 1. 商品列表

商品列表针对鱼助手/APP 点单，本期需要针对以上两个渠道做过滤：<span style="color:red">仅推送三个手工饮品的商品</span>。其ERP分类编码为：

```json
['10101','10102','10103'] # 分别为咖啡类，奶茶类，特调类
```



向鱼助手/APP 推送的商品列表为商品中台结构商品，已支持SPU - SKU 层级关系，但是由于还未进行管理，所以<span style="color:red">饮品还是平铺展示。</span>



### 2. 用户优惠券

用户优惠券鱼助手原需求是需要为用户展示以下状态的券：

1. 可使用券
2. 不可使用券（未过期）

在用户优惠券的展示逻辑上，可POS上有以下点不一致

1. POS内是先将商品添入购物车，再拿购物车内的所有商品去请求，获取当前商品可使用的券；如下列图所示：

2. 鱼助手是在同一界面上获取商品，添加购物车以及获取可用券；如下列图所示：

   

   **POS获取优惠券界面**


   ![POS获取优惠券](http://qiniu.hivan.me/picGo/20210111174853.png)

   

   **鱼助手获取优惠券界面**

   

   ![鱼助手获取优惠券](http://qiniu.hivan.me/picGo/20210111175141.png)

   

   **POS和鱼助手流程对比**

   

   ![POS&鱼助手 流程对比](http://qiniu.hivan.me/picGo/20210111175212.png)



以上流程的不同造成了获取优惠券的条件上会有所不一样，本期内因为时间周期较短，无法在逻辑上做处理，目前的鱼助手流程如果要实现动态获取券列表，只能是在购物车进行变化的情况下去重新获取券列表，包括商品变动、商品数量变动。

以上方法评估后对后端消耗过大，所以采取另外一种方案：<span style="color:red">在鱼助手的点单界面内，获取用户全部的可用优惠券（**此逻辑只针对鱼助手**），然后由前端去判断当前条件下优惠券是否可用。</span>但当进行支付的时候，后端需要对所有条件重新进行一次判断。



### 3.  用户进行下单支付

用户进行下单支付包含两个支付逻辑，1、扫码支付；2、会员卡支付；

在鱼助手的原界面逻辑上，支付宝支付和微信支付是区分开的，但是在POS的支付逻辑上，支付宝支付和微信支付是经由招行聚合支付进行了整合，只有一个扫码支付；

由于鱼助手内的支付是需要走POS原有的支付体系，所以<span style="color:red">鱼助手虽然展示了**鱼乐卡支付**和**微信支付**，但是实际上两个页面均调用的是招行支付二维码接口</span>，或者，建议鱼助手上<span style="color:red">整合成一个Tab”微信/支付宝 支付“</span> ，如下图鱼助手支付界面：

<img src="https://www.notion.so/image/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2Fb1e47550-e091-4f7e-82de-8e28795dbe76%2FUntitled.png?table=block&id=5fa270cf-5ad2-4c4c-9ca6-f88a2c5c2c72&width=2320&userId=4f93353d-181a-4410-94d6-f9f4b3a98955&cache=v2" alt="img" style="zoom: 33%;" />





在这个步骤内，需要一卡通更改原支付生成方式，因为POS内是扫码用户的支付二维码，而在鱼助手内，需要做的是调用招行接口生成一个支付二维码等待用户扫码，两者流程区别如下：

![image-20210111184938615](http://qiniu.hivan.me/picGo/20210111184938.png)



如上流程，整个支付流程需要针对鱼助手支付进行改造。



**在用户手机支付完成后，鱼助手上需要跳转状态。这里<span style="color:red">需要鱼助手向POS的服务做长轮询做查询；</span>**



### 4. 订单状态



#### 鱼助手订单状态比对

收集鱼助手上的订单状态如下：

**待付款、制作中、待取餐、已完成、已关闭、退款中、退款成功**

针对[不同订单状态的相关说明](https://www.notion.so/e84458449fa94312af9098d7052632db?v=d3611cb759144ab4b8bacffcef401552)

![image-20210112101454267](http://qiniu.hivan.me/picGo/20210112101454.png)



针对鱼助手状态说明，整理和筛选结果：

<span id="pending_pay"></span>

1. “待付款” 为生成了订单但是用户未完成付款的状态，此状态在用户持续未支付下不会一直保持，将在5分钟后自动失效。

   !> <span style="color:red">在POS原始业务内，待付款状态将保持2分钟，2分钟过后付款吗将会失效且订单关闭</span>

   ?> 待付款状态生成为用户成功下单，已为用户生成支付二维码的情况下开始计算时长，如果超过5分钟，则自动调用招行接口进行取消订单并在本地标记订单【[已关闭](#closed_order)】

2. 制作中、待取餐：<span style="color:red"> 这两个状态在POS的原有业务中是没有的，本期因为时间原因也不会进行支持，留待之后的迭代内针对POS业务和自助点单业务进行整体评估，进行整合后添加。</span>

   <span id="closed_order"></span>

3. 已关闭：此订单仅为【[待付款](#pending_pay)】状态转变的状态，如果一笔订单长期未成功付款或者在付款前被用户主动取消，都将会变为已关闭状态。

4. 退款中：POS的原有业务内无此状态，退款成功是接受的同步返回消息。如果第三方返回接受退款，则就认为是【[退款成功](#refunded_order)】，是否到帐的状态不做跟踪，此处暂按POS原有业务进行。

5. 已完成：POS原有业务内没有已完成这个订单状态，此处应该包含原有业务两种状态“【[不可退单](#不可退单)】”和“【[可退单](#可退单)】”, 将这两个状态都按照”**已完成**“推送给到鱼助手。

   <span id="refunded_order"></span>

6. 已退款：保持和POS业务相同，如果第三方（招行）返回接受退款，则认定为完成退款，订单变为“已退款”。因为<span style="color:red">鱼助手上不做退单业务，仅提示用户到吧台操作</span>>，所以这里仅接受订单状态为已退单，则标示为已退款；



#### 其他状态：



!> 由于页面可能长时间不刷新，订单状态的展示当以服务器判断为准；



##### 不可退单：

在POS业务内，因为财务帐务，使用优惠等原因，造成了订单支付完成之后无法退单。在这里和需求方在沟通之后，商定鱼助手上不做退单业务流程，如果用户需要发起退单，则鱼助手一并告知用户请至吧台进行退单。

但是此业务如果在“APP/小程序”上发起退单，则需要对此进行支持。由于业务上暂未商定退单详细规则（需要财务及营运共同制定），目前暂延续POS原有不可退单规则。

?> 建议APP上对不可退单做详尽描述，最难办的是“交班”后的订单，可以告知用户由于门店已完成班次切换无法退单，详情可咨询门店（附联系方式）

POS上不可退单状态如下图：

![image-20210112112607177](http://qiniu.hivan.me/picGo/20210112112607.png)



##### 可退单

订单在可退单状态内；



##### 订单异常

<span style="color:red">此状态为订单的特殊异常情况，出现机率较小，但是仍然有机会反应在订单上，鱼助手需要考虑是否对用户显示；</span>



### 5. POS接单及显示



POS上需要对自助点单订单做展示，当前业务内，APP渠道的点单为线上订单，鱼助手渠道内的点单则需要展示为线下点单。为了和POS点单做区分，所以订单上应该增加一个渠道字段，并需要对此字段做索引以便于日后查询。



**占位：POS内线下订单增加渠道后的展示和查询设计稿**



~~鱼助手在接单后POS上需要接受通知并在POS上进行展示通知，为防止漏单，此通知不会自动隐藏，需要店员进行手动关闭。如下图：~~



自助点单后的订单会以未读消息的形式展现在POS上，如图：

![image-20210120144348844](http://qiniu.hivan.me/picGo/20210120144348.png)



订单界面内，多增加一个Tab“鱼助手点单”，专门用户展示来自于“鱼助手”的订单，可以查看[来单提示](#关于Badge)；

[订单页面设计稿](https://lanhuapp.com/web/#/item/project/detailDetach?pid=6f9f64de-1c07-4610-9deb-383ee9188481&see=all&project_id=6f9f64de-1c07-4610-9deb-383ee9188481&image_id=259f789e-1748-4942-bc26-311b6671b4cd)

![image-20210120161736524](http://qiniu.hivan.me/picGo/20210120161736.png)



#### 关于Badge

订单的Badge数字来自于“鱼助手点单”和“线上点单”数量之和；

“鱼助手点单”及”线上点单“都仅展示自己的未处理消息；

当一个未处理订单被点开详情后，此条订单默认为处理状态，则数字减1；



关于自助点单的订单操作，包括”接单“、”制作中“、”制作完成“、”已取餐“这些特定业务流程，本期暂不支持，留待日后迭代内增加。



### 6. 财务报表

虽然是线下门店订单并且走的是POS的支付体系，但是由于渠道不同，需要和财务沟通是否需要在稽核报表内增加



## 优惠券说明

根据沟通结果，制定优惠券获取和使用规则如下：

1. 在商品选择添加购物车的时候根据券有效性去获取有效券和无效券；
2. 在点开券列表的时候根据购物车内是否有商品分别请求：
   1. 如果购物车内无商品，则向券中心请求获取全部券列表然后分类展示；
   2. 如果购物车内有商品，则根据商品向YMC请求可使用券，再向券中心获取所有券，比对后将可使用券及不可使用券分开展示；
   3. 更改购物车商品及数量不请求券；
   4. 鱼助手的”有XX张可用券“更改文案为”有XX张有效券“；
3. 在进入支付后，逻辑和POS一致，向YMC请求当前商品可使用券；
4. 鱼助手上选择券的列表头部显示文案”一笔订单仅可使用一张券“；
5. 和POS逻辑一致，一笔订单内如果包含低于12元（包含12元）商品不可使用券；







