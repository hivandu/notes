---
date: 2020-01-06
author: Hivan
---

# The Product Requirements Document for Coupon Center (beta)

:::warning
当前券中心规划尚处于初级阶段, 很多未完善的部分.可参看当前券中心规划脑图[^coupon_node]
:::

## 概述

由于目前网鱼券中心的规划限制以及逻辑问题, 致使网鱼券使用上出现了一些问题. 需要对券的管理等进行详尽的一个重新规划.

### 背景描述

当前网鱼的券存在多种问题, 比如用户券分两个系统进行管理, 券中心不管核验规则, 规则设置形同虚设, 属性设置添加困难, 无法应对业务增长等等. 为了让券符合业务发展, 需要对券中心做一次从新规划.

### 解决问题

当前券中心未合并, 管理困难, 无法扩展, 风评管理不够等.

## 系统概述

![](http://qiniu.hivan.me/mweb/2020-01/15788436119283.jpg)

原则: 规则, 执行相隔离

在设计上, 将拆分为四个部分:

1. [规则系统](#规则系统)
2. [活动系统](#活动系统)
3. [执行系统](#执行系统)
4. [数据系统](#数据系统)


## 规则系统


### 规则分类

规则上分为两类, 一类是限制规则, 一类是计算规则;

1. 限制规则是添加在券身上的各类属性, 用于限制券的发放, 领取以及使用;
2. 计算规则是在用户使用时具体的金额实现

除此之外, 还有各类规则之上, 还需要有两个统一管理规则: **优先级**和**互斥性[^_exclude]**, 这两个统一管理规则内, **优先级是可以调整的**, 保证无重复优先级规则即可, 而互斥性是需要在规则内限定死的. **互斥性在程序设定完成之后不可编辑**; 

关于规则, 仍然在做一个穷举. 具体可参看规则脑图[^coupon_rule], 当前尚未完全完善.

#### 限制性规则

##### 1. 渠道限制

渠道分为领取渠道和使用渠道两种,其中领取渠道不需要券中心去限制, 具体什么渠道需要做活动, 则由异业系统自行控制. 需要做控制的为使用渠道. 基本的逻辑为, 使用渠道由异业方自行提供, 从什么渠道进行领取的, 则带有这个渠道的属性, 如果异业方需要限制, 则仅可限制从自己这一个渠道进行兑换, 无法去控制其他渠道. 比如, APP领取的券, 最后控制仅限APP内进行核销或者不限制核销渠道

1. 自有券
    
    > 一般是指POS系统, “APP”是否作为异业系统需要进行商讨.
2. 合作券

    > 当选择合作券的时候, 需要有个选项用于提供选择合作方, 当然如果合作方, 可自行手动添加. 之后将生成的券模版ID给到合作方就可以直接进行对接发放了.


##### 2. 对象限制

1. 用户限制

    > 特殊用户限制, 有些券用户虽然领取了, 但是未达到标准依然无法使用. 比如: 必须注册APP后才可使用.

2. 门店限制
    - 单门店限制

        > 门店限制大部分时候为单店限制, 某些券来源于某家门店, 那么这种券仅可在那家门店进行兑换. 而也应该对区域, 分部进行限制, 以便区总, 分部总做一些区域活动.

    - 多门店选择限制
    - 区域限制
    - 分部限制
    - 混合限制
    
    :::warning
    做分部和区域限制, 需要在券上做券可用门店查询; 因为用户无法理解区域和分部的概念, 如显示“上海十一区门店可用”, 用户依然无法知道是哪些门店可用, 所以需要在券上展示当前券的可用门店列表.
    :::
    
    ![选择门店](http://qiniu.hivan.me/mweb/2020-01/15790676833722.jpg)


##### 3. 商品限制

:::tip
**品项和品类的限制可以相互组合,  比如限制了手工饮品, 并且又添加了几款瓶装饮料, 则限制上为:**
> 品类: 10102,10103,10104
> 品项: 1020201,1020202
:::

1. 限制品类
    - 一级品类限制
    - 二级品类限制
    - 多个品类限制
2. 限制品项
    - 单商品限制
    - 多商品限制
3. 混合限制
    - 品类选择后对单商品进行排除

##### 4. 时间限制

1. 相对时间

    > EQ: 1月
2. 绝对时间

    > EQ: 2020年1月1日 ~ 2020年1月30日

##### 5. 数量限制
数量限制也包含两种, 一部分是总体发行数量, 一部分是可使用数量.

1. 总数量限制
    
    > 营运很多时候需要对成本进行控制, 此时就需要在券的总体数量上进行控制.
2. 可使用数量

    > 用户在使用券的时候

##### 6. 金额限制

这里的金额限制仅是作为风控的总量限制. 券本身的金额限制将放在计算规则内.

##### 7. 受体限制

这里的受体分为两类, 一类是订单, 一类是商品. 优惠券需要区分受体, 特别是折扣券, 折扣受体不一样, 最后的结果也将不一样. 

1. 订单优惠
2. 商品优惠

##### 8. 状态限制

优惠券在程序生产之后具有状态, 不同阶段也会有不同的状态. 状态控制了券是否能够继续使用, 状态一共有如下几种:

1. 待领取
2. 未使用
3. 已锁定
4. 已使用
5. 已过期

**状态流转如下:**

![status for coupon](http://qiniu.hivan.me/mweb/2020-01/status%20for%20coupon.JPG)

:::tip
INFO:锁定状态会依赖订单状态, 而订单的未支付状态会依来源不同有不同的处理方式:
1. POS => 半小时后自动取消订单
2. 线上 => 为用户保留为支付状态
:::

#### 计算性规则
   
> 例子：
> 1. 立减5元
> 2. 满20减5
> 3. 每满20减3
	
##### 1. 扣减规则

1. 优惠模式
    - 固定金额优惠
    - 浮动金额优惠
    
        > 浮动金额限制==和折扣类型是相互排斥的==, 当设计浮动金额优惠的时候不允许选择折扣类型.
2. 优惠类型
    - 立减
       
        > 直接减扣的金额, 立减券多数时候可以用作代金券. 可以设定浮动金额优惠模式, 此时可以设置最大值和最小值 
    - 满减
       
        > 满多少减多少, 比如满20减5, 如果是浮动金额优惠模式, 则此券门槛不回变, 但是减免金额将会有个随机浮动; 如满20减 5~10. 此时在设置上需要填写最大值和最小值.
    - 折扣

        > 折扣券是在原有商品的基础上直接打折的类型券, 折扣券仅可在百分百比例之下填写.

##### 2. 封顶规则

封顶规则为用户对单个券使用时的最高减免金额, 一般出现在折扣券和代金券的叠加使用上.

#### 优先级
#### 互斥性

互斥性是指规则之间的相互不兼容, 有些规则和规则之间是无法共存的. 比如立减规则和封顶规则就无法同时存在, 某个规则如果存在,则相斥的规则无法添加到模版上. 规则互斥需要详尽定义, 如下表:


## 活动系统

## 执行系统

### 组合规则形成模版
### 券说明

券的使用限制条件对用户有的时候是需要明确告知的, 比如门槛, 过期时间, 状态以及一些限制. 除了在用户使用券的时候进行指导, 还包含了一些合规性问题.

### 组合模版生成券模版包
### 关于发放目标
### 筛选领取对象
### 计算最终成交价格
### 计算执行结果

## 数据系统

### 分析确定发放目标
### 记录发放记录
### 记录领取记录
### 记录使用记录
### 分析利用率等数据

## 基本功能

券从生产到核销的大致整体流程如下:

![](http://qiniu.hivan.me/mweb/2020-01/15794871019296.jpg)

### 模版管理

#### 创建模版

券中心需要界面将抽象规则一个个界面化, 并组合到一个模版里进行模版创建. 规则之间的互斥性以及规则将是一开始就在程序内设定好的, 无法更改. 优先级也是一开始在程序内设定了初始值, 但是规则优先级判断是可以做更改的. 在每个模版里进行组合的时候, 优先级都可以被改变. 是优先判断商品分类, 还是优先判断金额, 都由运营人员自行配置.

#### 模版查询

#### 模版复制

#### 模版修改

模版进行修改无法变更已通过此模版生成的所有券

### 活动管理

券中心的活动管理仅是对基本的规则模版进行组合管理

#### 活动创建

#### 活动查询

#### 活动复制

#### 活动修改

### 生成实体券
### 券核销
### 券管理
### 券查询
##### 模版编号查询
##### 券码查询
##### 证件号查询
##### 各类规则属性查询
#### 券操作
##### 过期券清理
##### 券状态更改


[^coupon_node]: https://my.mindnode.com/bqyKxpRKu864V7jxJPJNNAyzhfgFaNhyngSvMLsx
[^coupon_rule]: https://my.mindnode.com/7HqZkfLuN6yKQ6MqCB52ekiqqkGfqebjuoTTBJ7o
[^_exclude]: 互斥性是指规则之间的相互不兼容, 有些规则和规则之间是无法共存的. 比如立减规则和封顶规则就无法同时存在.